name: AquaQuality

on:
  push:
    branches: [ master ]
  pull_request:
  schedule:
    - cron: '17 2 * * *'  # nightly full+debug (02:17 UTC)
  workflow_dispatch:

jobs:
  aqua-fast:
    name: Aqua fast (light) ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: [ '1.10' ]
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
      - uses: julia-actions/cache@v2
      - name: Instantiate test environment
        run: |
          julia -e 'using Pkg; Pkg.activate("test"); Pkg.instantiate()'
      - name: Run Aqua fast level
        run: |
          julia --project=test -e 'using Pkg; Pkg.test("Mera"; test_args=["--color=yes"])' \
            --color=yes
        env:
          MERA_CI_MODE: true
          MERA_SKIP_HEAVY: true
          MERA_AQUA_LEVEL: fast
          AQUA_STRICT: false
          JULIA_NUM_THREADS: 1
  aqua-full:
    name: Aqua full (strict) ${{ matrix.version }}
    if: github.event_name != 'pull_request' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: [ '1.10' ]
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
      - uses: julia-actions/cache@v2
      - name: Instantiate test environment
        run: |
          julia -e 'using Pkg; Pkg.activate("test"); Pkg.instantiate()'
      - name: Run Aqua full strict
        run: |
          julia --project=test -e 'using Pkg; Pkg.test("Mera"; test_args=["--color=yes"])'
        env:
          MERA_CI_MODE: true
          MERA_SKIP_HEAVY: true
          MERA_AQUA_LEVEL: full
          AQUA_STRICT: true
          JULIA_NUM_THREADS: 1
  aqua-debug-nightly:
    name: Aqua debug recursive (nightly)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'
      - uses: julia-actions/cache@v2
      - name: Instantiate test environment
        run: |
          julia -e 'using Pkg; Pkg.activate("test"); Pkg.instantiate()'
      - name: Run Aqua debug recursive
        run: |
          julia --project=test -e 'using Pkg; Pkg.test("Mera"; test_args=["--color=yes"])'
        env:
          MERA_CI_MODE: true
          MERA_SKIP_HEAVY: true
          MERA_AQUA_LEVEL: debug
          AQUA_STRICT: true
          JULIA_NUM_THREADS: 1
